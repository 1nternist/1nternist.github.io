#!/bin/bash

CONVERT="armv7sconvert"
ARCHIVE="$1"
LIPO="/usr/bin/lipo"
AR="/usr/bin/ar"
TEMP="`mktemp -d -t build-XXXX`"
ARCH="`lipo -info $ARCHIVE | cut -d ':' -f3 | cut -d ' ' -f2-5 | sed 's/ /\n/g'`"

cp ${ARCHIVE} ${TEMP}
pushd ${TEMP}
for line in $ARCH; do
	if [ $line == "arm" ]; then
		${LIPO} -thin arm ${ARCHIVE} -output ${ARCHIVE}.arm
	fi
	if [ $line == "armv6" ]; then
		${LIPO} -thin armv6 ${ARCHIVE} -output ${ARCHIVE}.armv6
	fi
	if [ $line == "armv7" ]; then
		${LIPO} -thin armv7 ${ARCHIVE} -output ${ARCHIVE}.armv7
	fi
	if [ $line == "armv7s" ]; then
		${LIPO} -thin armv7s ${ARCHIVE} -output ${ARCHIVE}.armv7s
	fi
	if [ $line == "arm64" ]; then
		${LIPO} -thin arm64 ${ARCHIVE} -output ${ARCHIVE}.arm64
	fi
done
if [ -e ${ARCHIVE}.armv7 ]; then
	if [ ! -e ${ARCHIVE}.armv7s ]; then
		/usr/local/bin/armv7sconvert ${ARCHIVE}.armv7 ${ARCHIVE}.armv7s
	fi
fi

${LIPO} -create ${ARCHIVE}.* -output ${ARCHIVE}.new
popd
mv -f ${TEMP}/${ARCHIVE} ${ARCHIVE}.orig
mv -f ${TEMP}/${ARCHIVE}.new ${ARCHIVE}
chmod +x ${ARCHIVE}
ldid -S ${ARCHIVE}
rm -rf ${TEMP}
