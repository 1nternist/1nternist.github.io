#!/bin/bash

version="2.0"

echo "iRingtone $version, by Chir0student"
echo "Turn an mp3 of your choice into a ringtone!"
echo


if [ "$UID" != 0 ]
then
	echo "Error: You must be root to run this script!"
	exit
fi

if [ "$2" != "" ];
then
	orig=$1
	new=$2
else
	echo "Use:"
	echo "iRingtone </path/to/file.mp3> <new name> [start time] [length in secs]"
	echo
	echo "Example:"
	echo "iRingtone /private/var/mobile/Megadeth\ -\ Trust.mp3 Trust 0 40"
	echo "iRingtone \"/private/var/mobile/Megadeth - Trust\" \"Trust\""
	echo
	echo "PS: iTunes will not recognize ringtones over 40 sec"
	echo "Processing your request, the converting process takes a few seconds!"
	exit
fi

echo "Processing, wait..."

if [ "$4" != "" ]; then
	ffmpeg -i "$orig" -strict -2 -vn -ac 2 -ab 256000 -acodec aac -ss "$3" -t "$4" -f mp4 -y "$new".m4a >/dev/null 2>&1
	    elif [ "$3" != "" ]; then
		ffmpeg -i "$orig" -strict -2 -ac 2 -ab 256000 -acodec aac -ss 0 -t "$3" -f mp4 -y "$new".m4a >/dev/null 2>&1
else
	ffmpeg -i "$orig" -strict -2 -ac 2 -ab 256000 -acodec aac -f mp4 -y "$new".m4a >/dev/null 2>&1
fi

chmod 664 "$new".m4a
chown root "$new".m4a
chgrp admin "$new".m4a
mv "$new".m4a /Library/Ringtones/"$new".m4r

echo
echo "Done. You can now find $new in your iDevice's Preferences with other ringtones"

exit 0
